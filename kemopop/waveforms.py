import math

# ==========================================
# DG-LAB V3 Hex 波形数据 (来自 https://github.com/BobH233/DGLab-v2-PulseData)
# ==========================================
USER_HEX_WAVEFORMS = {
    "渐变弹跳": [
        "210100", "210103", "418106", "61010A", "610100", "810103", "A18106", "C1010A", "C10100", "C10103",
        "C28106", "E2010A", "E20100", "020203", "228206", "42020A", "420200", "420203", "628206", "82020A",
        "820200", "A20203", "C28206", "E2020A", "E20200", "E20203", "028306", "22030A", "220300", "420303",
        "628306", "82030A", "820300", "820303", "A28306", "C2030A", "C20300", "E20303", "028406", "22040A",
        "220400", "220403", "238406", "43040A", "430400", "630403", "838406", "A3040A", "000000", "000000"
    ],
    "节奏步伐": [
        "210100", "210102", "210104", "210106", "210108", "21010A", "210100", "218102", "210105", "218107",
        "21010A", "210100", "210103", "218106", "21010A", "210100", "210105", "21010A", "210100", "21010A",
        "210100", "21010A", "210100", "21010A", "210100", "21010A", "000000"
    ],
    "心跳节奏": [
        "46130A", "46130A", "46130A", "46130A", "46130A", "46130A", "210100", "210100", "210100", "210100",
        "210100", "218107", "210108", "210109", "21010A", "210100", "210100", "210100", "210100", "210100",
        "210100", "210100", "210100", "210100", "210100", "218107", "210108", "210109", "21010A", "210100",
        "210100", "210100", "210100", "210100", "000000"
    ],
    "信号灯": [
        "25440A", "25440A", "25440A", "25440A", "25440A", "25440A", "25440A", "25440A", "25440A", "25440A",
        "25440A", "25440A", "25440A", "25440A", "25440A", "25440A", "25440A", "25440A", "25440A", "25440A",
        "210100", "E10103", "C18206", "A1030A", "210100", "E10103", "C18206", "A1030A", "210100", "E10103",
        "C18206", "A1030A", "210100", "E10103", "C18206", "A1030A", "210100", "E10103", "C18206", "A1030A"
    ],
    "按捏渐强": [
        "210100", "218102", "210100", "210105", "210100", "210107", "210100", "218108", "210100", "21010A",
        "210100"
    ],
    "快速按捏": [
        "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A",
        "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A",
        "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A",
        "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A",
        "210100", "21010A", "210100", "21010A", "000000", "000000"
    ],
    "压缩": [
        "C4080A", "24080A", "84070A", "03070A", "63060A", "E3050A", "43050A", "A3040A", "22040A", "82030A",
        "02030A", "21010A", "21010A", "21010A", "21010A", "21010A", "21010A", "21010A", "21010A", "21010A",
        "21010A"
    ],
    "呼吸": [
        "210100", "210102", "210104", "210106", "210108", "21010A", "21010A", "21010A", "000000", "000000",
        "000000", "000000"
    ],
    "雨水冲刷": [
        "A10103", "A18106", "A1010A", "A10103", "A18106", "A1010A", "A10103", "A18106", "A1010A", "A10103",
        "A18106", "A1010A", "A10103", "A18106", "A1010A", "A10103", "A18106", "A1010A", "A10103", "A18106",
        "A1010A", "A10103", "A18106", "A1010A", "A10103", "A18106", "A1010A", "A10103", "A18106", "A1010A",
        "A10103", "A18106", "A1010A", "A10103", "A18106", "A1010A", "A10103", "A18106", "A1010A", "21070A",
        "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A",
        "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A",
        "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "21070A",
        "21070A", "21070A", "21070A", "21070A", "21070A", "21070A", "000000", "000000", "000000"
    ],
    "变速敲击": [
        "E1020A", "E1020A", "E1020A", "E10200", "E10200", "E10200", "E10200", "E1020A", "E1020A", "E1020A",
        "E10200", "E10200", "E10200", "E10200", "E1020A", "E1020A", "E1020A", "E10200", "E10200", "E10200",
        "E10200", "E1020A", "E1020A", "E1020A", "E10200", "E10200", "E10200", "E10200", "E1020A", "E1020A",
        "E1020A", "E10200", "E10200", "E10200", "E10200", "E1020A", "E1020A", "E1020A", "E10200", "E10200",
        "E10200", "E10200", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A",
        "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A",
        "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A",
        "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A", "A3130A",
        "000000", "000000"
    ],
    "波浪涟漪": [
        "210100", "210105", "21010A", "210107", "E20100", "E20105", "E2010A", "E20107", "E20200", "E20205",
        "E2020A", "E20207", "E20300", "E20305", "E2030A", "E20307", "A30400", "A30405", "A3040A", "A30407",
        "A30500", "A30505", "A3050A", "A30507", "A30600", "A30605", "A3060A", "A30607", "640700", "640705",
        "64070A", "640707", "640800", "640805", "64080A", "640807", "640900", "640905", "64090A", "640907",
        "440A00", "440A05", "440A0A", "440A07", "440B00", "440B05", "440B0A", "440B07", "250C00", "250C05",
        "250C0A", "250C07", "250D00", "250D05", "250D0A", "250D07", "000000"
    ],
    "颗粒摩擦": [
        "21010A", "41010A", "81010A", "C10100", "C1010A", "01020A", "41020A", "610200", "61020A", "A1020A",
        "E1020A", "210300", "21030A", "61030A", "81030A", "C10300", "C1030A", "01040A", "41040A", "810400",
        "81040A", "A1040A", "E1040A", "210500", "21050A", "61050A", "A1050A", "E10500"
    ],
    "挑逗2": [
        "810400", "210401", "E10302", "A10303", "610304", "018305", "C18206", "818207", "418208", "01020A",
        "810400", "210401", "E10302", "A10303", "610304", "018305", "C18206", "818207", "418208", "01020A",
        "810400", "210401", "E10302", "A10303", "610304", "018305", "C18206", "818207", "418208", "01020A",
        "810400", "210401", "E10302", "A10303", "610304", "018305", "C18206", "818207", "418208", "01020A",
        "210100", "41010A", "410100", "61010A", "610100", "81010A", "810100", "A1010A", "A10100", "C1010A",
        "C10100", "E1010A", "E10100", "01020A", "010200", "21020A", "210200", "41020A", "410200", "61020A",
        "610200", "81020A", "810200", "A1020A", "A10200", "C1020A", "C10200", "E1020A", "E10200", "01030A",
        "010300", "21030A", "210300", "41030A", "410300", "61030A", "610300", "81030A", "810300", "A1030A",
        "000000", "000000"
    ],
    "连击": [
        "21010A", "210100", "21010A", "218106", "210103", "210100", "210100", "210100"
    ],
    "挑逗1": [
        "210100", "618102", "A10105", "E18107", "21020A", "81020A", "C1020A", "010300", "410300", "A10300",
        "210100", "618102", "A10105", "E18107", "21020A", "81020A", "C1020A", "010300", "410300", "A10300",
        "210100", "618102", "A10105", "E18107", "21020A", "81020A", "C1020A", "010300", "410300", "A10300",
        "210100", "618102", "A10105", "E18107", "21020A", "81020A", "C1020A", "010300", "410300", "A10300",
        "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A",
        "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A", "210100", "21010A",
        "210100", "21010A", "000000", "210100", "618102", "A10105", "E18107", "21020A", "81020A", "C1020A",
        "010300", "410300", "A10300"
    ],
    "潮汐": [
        "210100", "418101", "810103", "A10105", "E18106", "210208", "41020A", "810209", "A10208", "E18207",
        "218306", "210300", "418301", "810303", "A10305", "E18306", "210408", "41040A", "810409", "A10408",
        "E18407", "218506", "000000"
    ]
}


def parse_hex_wave_step(hex_string):
    """
    Parses a 6-character hex string (FF II HH) into (frequency, intensity) tuple,
    assuming FF is frequency and HH is 0-10 scaled intensity, as per V2 protocol data format.
    """
    if len(hex_string) != 6:
        return (1, 0)

    try:
        freq_hex = hex_string[0:2]
        raw_freq = int(freq_hex, 16)
        frequency = max(1, min(100, raw_freq))

        int_hex = hex_string[4:6]
        scaled_int = int(int_hex, 16)

        if scaled_int > 10:
            intensity = 100
        else:
            intensity = math.floor((scaled_int / 10.0) * 100)

        return (frequency, intensity)

    except ValueError:
        return (1, 0)


# 解析导入的波形
IMPORTED_WAVEFORMS = {}
for name, hex_list in USER_HEX_WAVEFORMS.items():
    IMPORTED_WAVEFORMS[name] = [parse_hex_wave_step(h) for h in hex_list]

# ==========================================
# 1. 波形定义 (频率Hz, 强度0-100)
# 每个列表代表 100ms 的波形步进。
# ==========================================
WAVEFORMS = {
    "纯脉冲 (瞬时触发)": [
        (10, 100), (10, 100), (10, 100), (10, 100)
    ],
    "呼吸 (Breathe)": [
        (10, 0), (10, 20), (10, 40), (10, 60), (10, 80), (10, 100), 
        (10, 100), (10, 100), (10, 80), (10, 60), (10, 40), (10, 20), 
        (10, 0), (10, 0)
    ],
    "潮汐 (Tidal)": [
        (10, 0), (11, 16), (13, 33), (14, 50), (16, 66), (18, 83), 
        (19, 100), (18, 83), (16, 66), (14, 50), (13, 33), (11, 16), 
        (10, 0), (10, 0)
    ],
    "方波 (Square 50%)": [
        (20, 100), (20, 100), (20, 0), (20, 0)
    ],
    "升阶 (Ramp Up)": [
        (10, 0), (10, 25), (10, 50), (10, 75), (10, 100), (10, 0) 
    ],
    "心跳 (Heartbeat)": [
        (30, 90), (30, 30), (10, 0), (10, 0), (10, 0), (10, 0), (10, 0), (10, 0)
    ]
}

# 整合导入的波形
WAVEFORMS.update(IMPORTED_WAVEFORMS)


# ==========================================
# 波形序列定义 (列表中的项目必须是 WAVEFORMS 的键)
# ==========================================
WAVEFORM_SEQUENCES = {
    "测试循环 (Test Loop)": ["呼吸 (Breathe)", "潮汐 (Tidal)", "心跳 (Heartbeat)", "方波 (Square 50%)"],
    "渐强循环 (Ramp Cycle)": ["升阶 (Ramp Up)", "潮汐 (Tidal)", "方波 (Square 50%)"],
}

COMBO_DURATION_STEPS = 4

__all__ = [
    "WAVEFORMS",
    "WAVEFORM_SEQUENCES",
    "COMBO_DURATION_STEPS",
    "parse_hex_wave_step",
]
